{"version":3,"sources":["../../app/javascripts/routes.js"],"names":["request","require","express","bodyParser","app","use","urlencoded","extended","json","api","txLookup","registerRequest","address","tx","period","Date","now","pending","getTime","init","get","req","res","send","getBalance","params","then","result","getTotalTokens","getOutstandingDividends","payOutstandingDividends","value","console","log","post","body","callback","created","completed","outstanding","o","currentPeriod","p","Promise","resolve","reject","error","response","statusCode","amount","mintTokens","minted","payDividend","transfer","claimedTo","_claimedTo","dividendHistory","history","historyObj","i","length","withdrawal","push","accountBalance","r","lock","unlock","listen"],"mappings":"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","file":"routes.js","sourcesContent":["const request = require('request');\nconst express = require('express')\nconst bodyParser = require('body-parser');\nconst app = express()\n\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(bodyParser.json())\n\nvar api = require(\"./api.js\")\n\nvar txLookup = {}\n\nfunction registerRequest(address, tx, period) {\n  if(txLookup[address] == null) {\n    txLookup[address] = {};\n  }\n  txLookup[address][period] = {\"tx\" : tx,\n                               \"time\" : Date.now()};\n}\n\nfunction pending(address, period) {\n  if(txLookup[address] == null) {\n    return false;\n  }\n  if(txLookup[address][period] == null) {\n    return false;\n  }\n  return txLookup[address][period][\"time\"] <= new Date(Date.now().getTime() + 120*60000);\n}\n\napi.init();\n\napp.get('/', (req, res) => res.send('Hello World!'))\n\napp.get('/api/balance/:address', (req, res) => \n        api.getBalance(req.params[\"address\"]).then(function(result) {\n          res.send({\"total\" : result});\n        }));\n\napp.get('/api/total', (req, res) => \n        api.getTotalTokens().then(function(result) {\n          res.send({\"total\" : result});          \n        }));\n\napp.get('/api/dividends/:address', (req, res) =>\n        api.getOutstandingDividends(req.params[\"address\"]).then(function(result) {\n          res.send({\"owed\" : result});\n        }));\n\napp.get('/api/pay/:address', (req, res) => {\n  api.payOutstandingDividends(req.params[\"address\"], function (value) {console.log(value);} ).then(function(result) {\n    console.log(\"executed\");\n  })\n  res.send(\"submitted\");\n});\n\napp.post('/api/pay/', (req, res) => {\n  var params = req.body;\n  var address = params['address'];\n  var callback = params['callback'];\n  var created = Date.now();\n  var completed = 0;\n\n  var outstanding = 0;\n\n  console.log(\"address = \" + address + \" callback = \" + callback);\n\n  api.getOutstandingDividends(address).then(function(o) {\n    outstanding = o;\n    return api.currentPeriod();\n  }).then(function(p) {\n    if(outstanding > 0 && !pending(address, p)) {\n      return  api.payOutstandingDividends(address, function(value) {\n        console.log(\"pay dividend callback\");\n        console.log(value);\n        completed = Date.now();\n      });\n    } else {\n      return new Promise(function(resolve, reject) {\n        resolve(false);\n      });\n    }\n  }).then(function(result) {\n    console.log(\"posting to: \" + callback);\n    request.post(callback,\n                 {body: {\n                   \"completed\" :  completed,\n                   \"success\" : result,\n                   \"created\" :  created,\n                   \"address\" : address,\n                   \"_amount\" : outstanding},\n                  json: true},\n                 function (error, response, body) {\n                   if (!error && response.statusCode == 200) {\n                     console.log(body)\n                   } else {\n                     console.log(error)\n                   }\n                 });\n    res.send(\"OK!\");\n  })});\n\n\napp.get('/api/mint/:address/:amount', (req, res) => {\n  var address = req.params[\"address\"];\n  var amount = req.params[\"amount\"];\n  api.mintTokens(address, amount, function (minted) {\n    console.log(\"minted = \" + minted)}).then(function(result) {\n      res.send(result);\n    })});\n\napp.post('/test/callback', (req, res) => {\n  console.log(\"test callback...\");\n  res.send(req.body);\n});\n\napp.get('/test/dividend/:amount', (req, res) => {\n  api.payDividend(req.params[\"amount\"]).then(function(result) {\n    res.send(result);\n  });\n});\n\napp.get('/test/transfer/:to/:amount', (req, res) => {\n  api.transfer(req.params[\"to\"], req.params[\"amount\"]).then(function(result) {\n    res.send(result);\n  });\n});\n\napp.post('/api/mint/:address/:amount', (req, res) => {});\n\napp.get('/api/history/:address/', (req, res) => {\n  var claimedTo;\n  api.claimedTo(req.params[\"address\"]).then(function(_claimedTo) {\n    claimedTo = _claimedTo;\n    return api.dividendHistory(req.params[\"address\"]);\n  }).then(function(history) {\n    var historyObj = [];\n    console.log('claimed to ' + claimedTo);\n    for(var i = 0; i < history.length; i++) {\n      var withdrawal = 0;\n      if(i < claimedTo) {\n        withdrawal = Date.now();\n      }\n      console.log('adding history data');\n      if (history[i][\"amount\"] != null) {\n        historyObj.push({'id' : i,\n                         'amount' : history[i][\"amount\"],\n                         'date' : history[i][\"date\"],\n                         'withdrawal_date' : withdrawal,\n                         'wallet' : req.params[\"address\"]});\n      } \n    }\n    console.log(historyObj);\n    res.send(historyObj);\n  });\n});\n\napp.get('/api/ac/:address', (req, res) => {\n  api.accountBalance(req.params[\"address\"]).then(function(r) {\n    res.send(r);\n  });\n});\n\napp.get('/api/lock/:address', (req, res) => {\n  api.lock(req.params[\"address\"]).then(function(r) {\n    res.send(r);\n  });\n});\n\napp.get('/api/unlock/:address', (req, res) => {\n  api.unlock(req.params[\"address\"]).then(function(r) {\n    res.send(r);\n  });\n});\n\napp.listen(3000, () => console.log('API active on port 3000!'))\n\n"]}